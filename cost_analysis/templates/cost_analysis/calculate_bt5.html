{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成本计算</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'cost_analysis/styles.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
</head>

<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">洽兴成本报价</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a href="/admin/" class="nav-link">管理员</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-5">
    <div class="text-center mb-5">
        <h1 class="display-4 mt-5">成本计算</h1>
    </div>

    <div class="card p-4 mb-5 shadow-sm">
        <form method="post" action="{% url 'calculate_chuizhong' %}" id="form1">
            {% csrf_token %}
            <input type="hidden" name="name" id="nameInput">
            
            <!-- ... (其他表单元素，如选择框等) ... -->
            <div class="form-group">
                <label>选择零件编号:</label>
                <select name="selected_product" class="form-control">
                    {% for product in products %}
                    <option value="{{ product.id }}" {% if product.id|stringformat:"s" == request.POST.selected_product %}selected{% endif %}>
                        {{ product.part_number }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>选择材料:</label>
                <select name="selected_material" class="form-control">
                    {% for material in materials %}
                    <option value="{{ material.id }}" {% if material.id|stringformat:"s" == request.POST.selected_material %}selected{% endif %}>
                        {{ material.material_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>选择制造工艺、设备名称和设备型号:</label>
                <select name="selected_equipment" class="form-control" multiple id="select2-equipment">
                    {% for item in manufacturing_data %}
                    <optgroup label="{{ item.process }}">
                        {% for equipment in item.equipments %}
                        {% for model in equipment.models %}
                        {% with item_value=item.process|add:"|"|add:equipment.name|add:"|"|add:model %}
                        <option value="{{ item_value }}"
                                {% if item_value in selected_equipments %}selected{% endif %}>
                            {{ equipment.name }} - {{ model }}
                        </option>
                        {% endwith %}
                        {% endfor %}
                        {% endfor %}
                    </optgroup>
                    {% endfor %}
                </select>
            </div>
            
            
            

            
            <div class="form-group mt-3">
                <button type="submit" class="btn btn-primary btn-block">计算</button>
            </div>
        </form>
    </div>

    <!-- ... (其他卡片内容) ... -->
    <div class="card p-4">
        <div class="mb-4">
            <h2>材料费</h2>
            {% if material_result %}
            <p class="bg-info text-white p-2 rounded"><strong>结果:</strong> {{ material_result }}</p>
            {% endif %}
        </div>

        <div class="mb-4">
            <h2>包装费</h2>
            {% if packaging_result %}
            <p class="bg-info text-white p-2 rounded"><strong>结果:</strong> {{ packaging_result }}</p>
            {% endif %}
        </div>

        <div class="mb-4">
            <h2>运输费</h2>
            {% if shipping_result %}
            <p class="bg-info text-white p-2 rounded"><strong>结果:</strong> {{ shipping_result }}</p>
            {% endif %}
        </div>

        <div class="mb-4">
            <h2>加工费</h2>
            {% if processing_result %}
            <p class="bg-info text-white p-2 rounded"><strong>结果:</strong> {{ processing_result }}</p>
            {% endif %}
        </div>

        <div class="mb-4">
            <h2>总成本</h2>
            {% if total_cost %}
            <h4 class="mt-3">总成本:</h4>
            <p class="bg-info text-white p-2 rounded">{{ total_cost }}</p>
            {% endif %}
        </div>
    </div>
</div>

</div>
<script>
    function getURLParameter(name) {
        var match = new RegExp('[?|&]' + name + '=([^&;]+?)(&|#|;|$)').exec(location.search);
        if (match) {
            return decodeURIComponent(match[1].replace(/\+/g, '%20'));
        }
        return null;
    }
</script>

<!-- <script>
    $(document).ready(function() {
        $('select').select2(); // 初始化所有的下拉菜单
});
</script> -->
<script>


const name = getURLParameter('name');
if (name) {
localStorage.setItem('name', name);
}
const storedName = localStorage.getItem('name');
if (storedName) {
const titleElement = document.querySelector('h1');
titleElement.textContent = `${storedName}成本计算`;
}

window.addEventListener('DOMContentLoaded', (event) => {
const name = getURLParameter('name');
if (name) {
    document.getElementById('nameInput').value = name;
    const titleElement = document.querySelector('h1');
    titleElement.textContent = `${name}成本计算`;
}

});





</script>



<!-- Bootstrap JS -->
<script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.1/js/bootstrap.bundle.min.js"></script>
<!-- ... (其他JavaScript代码) ... -->

<footer class="mt-5 py-4 bg-primary text-white">
    <div class="text-center">
        <p>&copy; Etale.ai. All rights reserved.</p>
    </div>
</footer>

</body>
</html>
