{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成本计算</title>
    <link href="{% static 'bootstrap.min.css' %}", rel="stylesheet">
    <link rel="stylesheet" href="{% static 'cost_analysis/styles.css' %}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="{% static 'js/particles.js' %}"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .display-4 {
    color: #fff;
}
.narrow-container {
    max-width: 800px;
}
.navbar.bg-primary, .btn-gradient{
    background: linear-gradient(to right, rgb(112, 151, 183), rgb(163, 154, 164));
    opacity: 0.9;
}

body .text-gradient{
    background: linear-gradient(to right, rgb(112, 151, 183), rgb(163, 154, 164));
    color:white
}
.btn-gradient{
    color:white;
    border:none;
}
#particles-js {
    position: absolute;
    width: 100%;
    height: 100%;
    z-index: -1;
}
body {
    background: radial-gradient(circle, #000000, #797878);
}
body::before {
    content: "";
    position: absolute;
    width: 100%;
    height: 100%;
    opacity: 0.2;
}
footer {
    font-size: 20px;
    color:#fff;
}
.card {
    background: linear-gradient(to bottom, #ffffff, #f1f1f1);
    opacity: 0.9;
}

canvas {
    padding-left: 0;
    padding-right: 0;
    margin-left: auto;
    margin-right: auto;
    display: block;
    width: 700px;
}

    </style>
</head>

<body>
    <div id="particles-js"></div>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <a class="navbar-brand" href="/">
            <img src="{% static 'logo.jpeg' %}" alt="Logo" style="width: 60px; height: 60px; margin-right: 10px;">
            洽兴成本报价</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a href="/admin/" class="nav-link fa-solid fa-user">管理员</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container mt-5 narrow-container">
        <div class="text-center mb-5">
            <h1 class="display-4">成本计算</h1>
        </div>

        <!-- Calculation Card -->
        <div class="card p-4 mb-5">
            <form method="post" action="{% url 'calculate_'|add:category %}" id="form1">
                {% csrf_token %}
                <!-- <input type="hidden" name="form_name" value="form1"> -->
                <input type="hidden" name="name" id="nameInput">
                <div class="form-group">
                    <label>选择零件编号:</label>
                    <select name="selected_product" class="form-control">
                        {% for product in products %}
                        <option value="{{ product.id }}" {% if product.id|stringformat:"s" == request.POST.selected_product %}selected{% endif %}>
                            {{ product.part_number }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group mt-2">
                    <label>选择制造工艺、设备名称和设备型号:</label>
                    <select name="selected_equipment" class="form-control" multiple id="select2-equipment">
                        {% for item in manufacturing_data %}
                        <optgroup label="{{ item.process }}">
                            {% for equipment in item.equipments %}
                            {% for model in equipment.models %}
                            {% with item_value=item.process|add:"|"|add:equipment.name|add:"|"|add:model %}
                            <option value="{{ item_value }}"
                                    {% if item_value in selected_equipments %}selected{% endif %}>
                                {{ equipment.name }} - {{ model }}
                            </option>
                            {% endwith %}
                            {% endfor %}
                            {% endfor %}
                        </optgroup>
                        {% endfor %}
                    </select>
                </div>

                <div id="input-container">
                    <!-- Dynamic inputs will be appended here -->
                  </div>
                

                <div class="form-group">
                    <button type="submit" class="btn btn-gradient btn-block mt-2">计算</button>
                </div>
            </form>

        </div>

        <!-- Results Card -->
        <div class="card p-4">
            <h1 class = "text-center">费用统计</h1>
            <div class="mb-4">
                <h2>材料费</h2>
                {% if material_result is not None %}
                <p class="text-gradient text-black p-2 rounded"><strong>结果:</strong> {{ material_result }}</p>
                {% endif %}
            </div>

            <div class="mb-4">
                <h2>加工费</h2>
                {% if processing_result is not None %}
                <p class="text-gradient text-black p-2 rounded"><strong>结果:</strong> {{ processing_result }}</p>
                {% endif %}
            </div>

            <div class="mb-4">
                <h2>包装费</h2>
                {% if packaging_result is not None %}
                <p class="text-gradient text-black p-2 rounded"><strong>结果:</strong> {{ packaging_result }}</p>
                {% endif %}
            </div>

            <div class="mb-4">
                <h2>运输费</h2>
                {% if shipping_result is not None %}
                <p class="text-gradient text-black p-2 rounded"><strong>结果:</strong> {{ shipping_result }}</p>
                {% endif %}
            </div>
            
            <div class="mb-4">
                <h2>管理费</h2>
                {% if processing_result is not None %}
                <p class="text-gradient text-black p-2 rounded"><strong>结果:</strong> {{ managing_result }}</p>
                {% endif %}
            </div>

            <div class="mb-4">
                <h2>利润</h2>
                {% if processing_result is not None %}
                <p class="text-gradient text-black p-2 rounded"><strong>结果:</strong> {{ profit }}</p>
                {% endif %}
            </div>

            <div class="mb-4">
                <h2>总成本</h2>
                {% if total_cost is not None %}
                <p class="text-gradient text-black p-2 rounded"><strong>结果:</strong> {{ total_cost }}</p>
                {% endif %}
            </div>

            <div class="col-md-6">
                <canvas id="costChart" width="400" height="400"></canvas>
            </div>
        </div>
    </div>

    <!-- <script>
        document.getElementById('saveButton').addEventListener('click', function() {
        document.getElementById('saveFlag').value = 'true';
    });
    </script> -->


    <script>
        function getURLParameter(name) {
            var match = new RegExp('[?|&]' + name + '=([^&;]+?)(&|#|;|$)').exec(location.search);
            if (match) {
                return decodeURIComponent(match[1].replace(/\+/g, '%20'));
            }
            return null;
        }
    </script>

    <script>
        $(document).ready(function() {
            $('select').select2(); // 初始化所有的下拉菜单
});
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const selectElement = document.getElementById("select2-equipment");
        const inputContainer = document.getElementById("input-container");

        const addButton = document.createElement('button');
        addButton.innerHTML = '<i class="fas fa-check"></i>';  // 使用Font Awesome图标
        addButton.className = 'btn btn-primary mt-3'; // Bootstrap样式
        addButton.type = 'button';
        // addButton.style.marginBottom= '10px';
        addButton.style.margin = '0 10px 10px 0';
        addButton.addEventListener('click', function() {
            addSelectedEquipments();
        });
        

        const removeButton = document.createElement('button');
        removeButton.innerHTML = '<i class="fas fa-trash"></i>'; // 使用Font Awesome图标
        removeButton.className = 'btn btn-danger mt-3'; // Bootstrap样式
        removeButton.type = 'button';
        removeButton.style.marginBottom= '10px';
        removeButton.addEventListener('click', function() {
            removeSelectedEquipments();
        });

        inputContainer.appendChild(addButton);
        inputContainer.appendChild(removeButton);

        function addSelectedEquipments() {
            const selectedOptions = Array.from(selectElement.selectedOptions);
            
            selectedOptions.forEach(option => {
                const equipmentValue = option.value;
                const label = option.textContent;
                const inputGroup = document.createElement("div");
                inputGroup.classList.add("input-group", "mb-3");
                inputGroup.id = `group_${equipmentValue}`;
                
                inputGroup.innerHTML = `
                    <div class="col-sm-4">
                        <label>${label} 合格率:</label>
                        <input type="number" min = "1" max = "100" class="form-control" name="qualification_rate_${equipmentValue}" placeholder="合格率(%)">
                    </div>
                    <div class="col-sm-4">
                        <label>每小时产能:</label>
                        <input type="number" min = "1" class="form-control" name="hourly_capacity_${equipmentValue}" placeholder="每小时产能(个)">
                    </div>
                    <div class="col-sm-4">
                        <label>工艺次数:</label>
                        <input type="number" min = "1" class="form-control" name="times_${equipmentValue}" placeholder="1">
                    </div>
                    <div class="col-sm-4">
                        <label>操作员人数:</label>
                        <input type="number" min = "0" class="form-control" name="operator_count_${equipmentValue}" placeholder="默认产品信息的人数">
                    </div>
                    <div class="col-sm-4">
                        <label>操作员工资:</label>
                        <input type="number" min = "0" class="form-control" name="operator_wages_${equipmentValue}" placeholder="默认供应商信息的工资">
                    </div>
                    `;
                    // <div class="col-sm-4 text-right">
                    //     <button type="button" class="btn btn-danger mt-4" onclick="removeGroup('group_${equipmentValue}')">移除</button>
                    // </div>

                inputContainer.appendChild(inputGroup);
                const qualificationRateInput = inputGroup.querySelector(`input[name="qualification_rate_${equipmentValue}"]`);
                const hourlyCapacityInput = inputGroup.querySelector(`input[name="hourly_capacity_${equipmentValue}"]`);
                const timesInput = inputGroup.querySelector(`input[name="times_${equipmentValue}"]`);
                const operatorCountInput = inputGroup.querySelector(`input[name="operator_count_${equipmentValue}"]`);
                const operatorWagesInput = inputGroup.querySelector(`input[name="operator_wages_${equipmentValue}"]`);
                
                [qualificationRateInput, hourlyCapacityInput, timesInput, operatorCountInput, operatorWagesInput].forEach(input => {
                    input.addEventListener('input', function() {
                        let value = parseFloat(this.value);
                        if (this.name.startsWith('qualification_rate_')) {
                            if (value < 0 || value > 100) {
                                alert('合格率应在 0-100 之间');
                                this.value = '';
                            }
                        } else {
                            if (value < 0) {
                                alert('数值应为正数');
                                this.value = '';
                            }
                        }
                    });
                });
            });
        }

    function removeSelectedEquipments() {
        const selectedOptions = Array.from(selectElement.selectedOptions);
        
        selectedOptions.forEach(option => {
            const equipmentValue = option.value;
            const inputGroup = document.getElementById(`group_${equipmentValue}`);
            if (inputGroup) {
                inputGroup.remove();
            }
        });
    }

    window.removeGroup = function(groupID) {
        const inputGroup = document.getElementById(groupID);
        if (inputGroup) {
            inputGroup.remove();
        }
    }
});


    </script>

<script>



const name = getURLParameter('name');
if (name) {
    localStorage.setItem('name', name);
}
const storedName = localStorage.getItem('name');
if (storedName) {
    const titleElement = document.querySelector('h1');
    titleElement.textContent = `${storedName}成本计算`;
}

window.addEventListener('DOMContentLoaded', (event) => {
    const name = getURLParameter('name');
    if (name) {
        document.getElementById('nameInput').value = name;
        const titleElement = document.querySelector('h1');
        titleElement.textContent = `${name}成本计算`;
    }

});
</script>
<script>
    $(document).ready(function() {
    const selectElement = $('#select2-equipment');

    // 初始化 Select2
    selectElement.select2();

    // 从 LocalStorage 获取保存的选项
    const selectedItems = localStorage.getItem('selectedEquipment');
    if (selectedItems) {
        const items = JSON.parse(selectedItems);
        selectElement.val(items).trigger('change');
    }

    // 当用户更改选择时保存到 LocalStorage
    selectElement.on('change', function() {
        const selected = $(this).val();
        localStorage.setItem('selectedEquipment', JSON.stringify(selected));
    });
});

document.addEventListener('DOMContentLoaded', function() {
            particlesJS.load('particles-js', '{% static "js/particles.json" %}', function() {
                console.log('particles.js loaded - callback');
            });
        });
</script>



<script>
// 在已有的 DOMContentLoaded 函数内部添加以下内容
document.addEventListener("DOMContentLoaded", function () {
    // ...（你原有的代码）

    const submitButton = document.querySelector("button[type='submit']"); // 获取已存在的提交按钮

    submitButton.addEventListener('click', function (e) {
        validateInputs(e);
    });

    function validateInputs(e) {
        const inputGroups = document.querySelectorAll('.input-group');

        for (const group of inputGroups) {
            const qualificationInput = group.querySelector("input[name^='qualification_rate_']");
            const hourlyCapacityInput = group.querySelector("input[name^='hourly_capacity_']");

            if (!qualificationInput.value || !hourlyCapacityInput.value) {
                alert('未输入每小时产能或合格率！');
                e.preventDefault();
                return;
            }
        }
    }
});


</script>


<script src="{%static 'bootstrap.min.js' %}"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // 数据用于扇形图，用动态值替换这些
    const data = {
      labels: ['材料费', '加工费', '包装费', '运输费', '管理费', '利润'],
      datasets: [{
        data: [{{ material_result }}, {{ processing_result }}, {{ packaging_result }}, {{ shipping_result }}, {{ managing_result }}, {{ profit }}],
        backgroundColor: ['#ff6384', '#36a2eb', '#cc65fe', '#ffce56', '#48de73', '#f26d6d']
      }]
    };

    // 创建图表
    const ctx = document.getElementById('costChart').getContext('2d');
    new Chart(ctx, {
      type: 'pie',
      data: data
    });
  </script>

<footer class="mt-5">
    <div class="text-center">
        <p>&copy; Etale.ai. All rights reserved.</p>
    </div>
</footer>

</body>
</html>
